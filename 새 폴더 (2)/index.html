<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영어 듣기 & 단어 번역 (프리미엄 버전)</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .section {
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            flex: 1 1 350px;
            min-width: 280px;
        }
        @media (max-width: 700px) {
            .main-layout {
                flex-direction: column;
            }
        }
        h2 {
            margin-top: 0;
            font-weight: 600;
            color: #2c3e50;
        }
        textarea {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
            min-height: 100px;
            font-size: 1rem;
            font-family: inherit;
            background: #fafbfc;
        }
        label {
            display: block;
            margin-top: 10px;
            font-size: 0.95rem;
            color: #34495e;
        }
        select, input[type="range"] {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fafbfc;
            margin-top: 4px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        button {
            flex: 1 1 auto;
            padding: 10px 12px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button.primary {
            background-color: #4a90e2;
        }
        button.primary:hover {
            background-color: #407ec8;
        }
        button.secondary {
            background-color: #7f8c8d;
        }
        button.secondary:hover {
            background-color: #707b7c;
        }
        .reading-container {
            position: relative;
            background: #fafbfc;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            min-height: 60px;
            overflow-y: auto;
        }
        .reading-display span {
            cursor: pointer;
            padding: 2px 0;
        }
        .highlight {
            background-color: #ffeb99;
        }
        /* 노란 박스 스타일 */
        #highlightBox {
            position: absolute;
            border: 2px solid #f1c40f;
            border-radius: 4px;
            pointer-events: none;
            transition: left 0.15s ease, top 0.15s ease;
            box-sizing: border-box;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        li {
            background: #f8f9fa;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 8px;
        }
        .synonyms {
            font-size: 0.85rem;
            color: #555;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div class="main-layout">
    <!-- 왼쪽 섹션: 입력 및 재생 -->
    <div class="section">
        <h2>문장 입력 & 듣기</h2>
        <textarea id="inputText" placeholder="Enter English text here..." oninput="stopSpeechOnInput()"></textarea>

        <label>목소리 선택:
            <select id="voiceSelect"></select>
        </label>

        <label>속도 조절: <span id="rateDisplay">1.0</span>x
            <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" oninput="updateRateDisplay()">
        </label>

        <div class="button-group">
            <button class="primary" onclick="startSpeech()">재생</button>
            <button class="secondary" onclick="pauseResumeSpeech()" id="pauseBtn">일시정지</button>
            <button class="secondary" onclick="stopSpeech()">정지</button>
        </div>

        <label>진행 위치:
            <input type="range" id="progressSlider" min="0" max="0" step="1" value="0" oninput="seekSpeech()">
        </label>

        <!-- 읽는 위치 및 노란 박스 표시 -->
        <div class="reading-container">
            <div id="readingDisplay" class="reading-display"></div>
            <div id="highlightBox"></div>
        </div>
    </div>

    <!-- 오른쪽 섹션: 단어 뜻, 품사, 동의어 -->
    <div class="section">
        <h2>단어 뜻 & 품사</h2>
        <ul id="translationList"></ul>
    </div>
</div>

<script>
    // 사전 데이터: 단어 -> {mean: 뜻, pos: 품사, synonyms: 동의어 배열}
    const dictionary = {
        'hello': { mean: '안녕하세요', pos: '감탄사', synonyms: ['hi', 'greetings'] },
        'world': { mean: '세계', pos: '명사', synonyms: ['earth', 'globe'] },
        'study': { mean: '공부하다', pos: '동사', synonyms: ['learn', 'research'] },
        'computer': { mean: '컴퓨터', pos: '명사', synonyms: ['pc', 'machine'] },
        'language': { mean: '언어', pos: '명사', synonyms: ['tongue', 'speech'] },
        'book': { mean: '책', pos: '명사', synonyms: ['volume', 'text'] },
        'school': { mean: '학교', pos: '명사', synonyms: ['academy', 'institution'] },
        'friend': { mean: '친구', pos: '명사', synonyms: ['pal', 'mate'] },
        'love': { mean: '사랑', pos: '명사', synonyms: ['affection', 'fondness'] },
        'beautiful': { mean: '아름다운', pos: '형용사', synonyms: ['pretty', 'lovely'] },
        'run': { mean: '달리다', pos: '동사', synonyms: ['dash', 'sprint'] }
    };
    const stopwords = new Set(['the','a','an','and','of','to','in','on','at','for','is','are','was','were','be','been','it','that','this','with','as','by','from']);

    let words = [];
    let charPositions = [];
    let currentWordIndex = 0;
    let isPaused = false;
    let utterance = null;
    let startIndexGlobal = 0; // 전체 문장에서 시작할 인덱스 저장

    // 브라우저 음성 목록 불러오기 및 기본 설정
    function populateVoices() {
        const synth = window.speechSynthesis;
        const voiceSelect = document.getElementById('voiceSelect');
        const voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach((voice, index) => {
            if (voice.lang.startsWith('en')) {
                const option = document.createElement('option');
                option.value = index;
                option.text = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            }
        });
        // Google US English를 기본으로, 없으면 첫 번째 음성 선택
        const defaultVoiceIndex = voices.findIndex(v => v.name.includes('Google') && v.lang === 'en-US');
        if (defaultVoiceIndex >= 0) {
            voiceSelect.selectedIndex = [...voiceSelect.options].findIndex(opt => opt.value == defaultVoiceIndex);
        } else if (voiceSelect.options.length > 0) {
            voiceSelect.selectedIndex = 0;
        }
    }
    window.speechSynthesis.onvoiceschanged = populateVoices;

    // 속도 표시 갱신
    function updateRateDisplay() {
        const slider = document.getElementById('rateSlider');
        document.getElementById('rateDisplay').textContent = slider.value;
    }

    // 읽기 시작 또는 특정 위치에서 시작
    function startSpeech(startIdx = 0) {
        const input = document.getElementById('inputText').value.trim();
        if (!input) return;

        const synth = window.speechSynthesis;
        synth.cancel(); // 기존 재생 중지
        isPaused = false;
        document.getElementById('pauseBtn').textContent = '일시정지';

        // 단어 추출
        words = input.split(/\s+/);
        startIndexGlobal = startIdx;

        // 남은 텍스트 계산
        const remainingWords = words.slice(startIdx);
        const remainingText = remainingWords.join(' ');

        // 전체 charPositions 계산 (참고용)
        charPositions = [];
        let pos = 0;
        for (let i = 0; i < words.length; i++) {
            charPositions[i] = pos;
            pos += words[i].length + 1;
        }

        // 읽기 표시 영역 생성
        const displayDiv = document.getElementById('readingDisplay');
        displayDiv.innerHTML = '';
        words.forEach((word, index) => {
            const span = document.createElement('span');
            span.textContent = word + ' ';
            span.setAttribute('data-index', index);
            span.onclick = () => startSpeech(index); // 클릭 시 그 위치부터 읽기 시작
            displayDiv.appendChild(span);
        });

        // 하이라이트 박스 초기화
        removeHighlight();

        // 진행 슬라이더 값 설정
        const progressSlider = document.getElementById('progressSlider');
        progressSlider.max = words.length - 1;
        progressSlider.value = startIdx;

        // 번역 결과 업데이트
        displayTranslations(input);

        // Utterance 생성
        utterance = new SpeechSynthesisUtterance(remainingText);
        const voices = synth.getVoices();
        const selectedIndex = document.getElementById('voiceSelect').value;
        if (selectedIndex && voices[selectedIndex]) {
            utterance.voice = voices[selectedIndex];
        }
        utterance.rate = parseFloat(document.getElementById('rateSlider').value);

        currentWordIndex = startIdx;
        highlightWord(currentWordIndex);

        // boundary 이벤트: 읽는 단어 추적
        utterance.onboundary = (event) => {
            if (event.name === 'word') {
                const charIndex = event.charIndex;
                // 남은 텍스트에서 현재 단어 인덱스 파악
                let localPositions = [];
                let p = 0;
                for (let i = 0; i < remainingWords.length; i++) {
                    localPositions[i] = p;
                    p += remainingWords[i].length + 1;
                }
                let localIndex = remainingWords.length - 1;
                for (let i = 0; i < localPositions.length; i++) {
                    if (charIndex >= localPositions[i] && (i === localPositions.length - 1 || charIndex < localPositions[i+1])) {
                        localIndex = i;
                        break;
                    }
                }
                currentWordIndex = startIndexGlobal + localIndex;
                highlightWord(currentWordIndex);
                document.getElementById('progressSlider').value = currentWordIndex;
            }
        };

        // 읽기 시작
        synth.speak(utterance);
    }

    // 일시정지/재개 토글
    function pauseResumeSpeech() {
        const synth = window.speechSynthesis;
        if (!synth.speaking) return;
        if (isPaused) {
            synth.resume();
            document.getElementById('pauseBtn').textContent = '일시정지';
        } else {
            synth.pause();
            document.getElementById('pauseBtn').textContent = '재개';
        }
        isPaused = !isPaused;
    }

    // 정지
    function stopSpeech() {
        const synth = window.speechSynthesis;
        synth.cancel();
        isPaused = false;
        document.getElementById('pauseBtn').textContent = '일시정지';
        removeHighlight();
    }

    // 입력 수정 시 재생 중지
    function stopSpeechOnInput() {
        stopSpeech();
    }

    // 페이지 떠날 때 재생 중지
    window.addEventListener('beforeunload', () => {
        window.speechSynthesis.cancel();
    });

    // 하이라이트 업데이트 + 노란 박스 이동
    function highlightWord(index) {
        const spans = document.querySelectorAll('#readingDisplay span');
        spans.forEach(span => span.classList.remove('highlight'));

        const highlightBox = document.getElementById('highlightBox');
        const displayDiv = document.getElementById('readingDisplay');
        if (spans[index]) {
            const span = spans[index];
            span.classList.add('highlight');
            // 위치 계산: 컨테이너 기준
            const spanRect = span.getBoundingClientRect();
            const containerRect = displayDiv.getBoundingClientRect();

            const left = spanRect.left - containerRect.left + displayDiv.scrollLeft;
            const top = spanRect.top - containerRect.top + displayDiv.scrollTop;
            highlightBox.style.display = 'block';
            highlightBox.style.left = `${left}px`;
            highlightBox.style.top = `${top}px`;
            highlightBox.style.width = `${spanRect.width}px`;
            highlightBox.style.height = `${spanRect.height}px`;
        } else {
            highlightBox.style.display = 'none';
        }
    }
    function removeHighlight() {
        document.querySelectorAll('#readingDisplay span').forEach(span => span.classList.remove('highlight'));
        document.getElementById('highlightBox').style.display = 'none';
    }

    // 진행 슬라이더 조절 시: 해당 위치부터 읽기
    function seekSpeech() {
        const targetIndex = parseInt(document.getElementById('progressSlider').value, 10);
        if (targetIndex >= 0 && targetIndex < words.length) {
            startSpeech(targetIndex);
        }
    }

    // 번역 표시
    function displayTranslations(text) {
        const list = document.getElementById('translationList');
        list.innerHTML = '';
        const uniqueWords = [...new Set(
            text.split(/\s+/)
                .map(w => w.toLowerCase().replace(/[^a-z]/g, ''))
                .filter(w => w)
        )];
        uniqueWords.forEach(word => {
            if (stopwords.has(word)) return;
            const dictEntry = dictionary[word];
            const mean = dictEntry?.mean || '알 수 없음';
            const pos = dictEntry?.pos || '';
            const synonyms = dictEntry?.synonyms?.length ? dictEntry.synonyms.join(', ') : '';
            const li = document.createElement('li');
            li.innerHTML = `<strong>${word}</strong> ${pos ? '(' + pos + ')' : ''} → ${mean}`
                + (synonyms ? `<div class="synonyms">동의어: ${synonyms}</div>` : '');
            list.appendChild(li);
        });
    }
</script>
</body>
</html>
